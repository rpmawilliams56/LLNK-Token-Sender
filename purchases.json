// ... inside your VERIFIED IPN processing block

// Load existing purchases or initialize empty array
$jsonPath = __DIR__ . '/purchases.json';
$purchases = file_exists($jsonPath) ? json_decode(file_get_contents($jsonPath), true) : [];

// Check for duplicate txn_id
if (isset($purchases[$txn_id])) {
    header("HTTP/1.1 200 OK");
    exit('Duplicate transaction ID detected. Already processed.');
}

// Validate partner key (your existing validation)

// Save purchase with item_name included
$purchases[$txn_id] = [
    'payment_status' => $payment_status,
    'payer_name'     => $payer_name,
    'email'          => $payer_email,
    'amount'         => $payment_amount,
    'currency'       => $payment_currency,
    'partner'        => $custom,
    'item_name'      => $item_name,       // <--- ADD THIS LINE
    'timestamp'      => date('c')
];

// Write back to JSON file
file_put_contents($jsonPath, json_encode($purchases, JSON_PRETTY_PRINT));

// Continue with rest of your IPN handling...
